#order_layout.pure-g
  #details.pure-u
    .content

.order-table-content
  .pure-g.header-filter-container
    .pure-u
      .delete-button
        %button.btn#btn_delete_orders
          Delete
    .pure-u-1-5
      %label Status
      %select.filter-orders.status
        %option All
        %option Saved
        %option Draft
    .pure-u-1-5
      %label Account Manager
      %select.filter-orders.am
        %option Select
        - @users.each do |user|
          %option{:value => user.id}= "#{user.first_name} #{user.last_name} - #{user.email}"
    .pure-u-1-5
      %label Trafficker
      %select.filter-orders.trafficker
        %option Select
        - @users.each do |user|
          %option{:value => user.id}= "#{user.first_name} #{user.last_name} - #{user.email}"
    .pure-u-1-5

  %table.order-table
    %thead
      %tr
        %th
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                Status
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                ID
            .pure-u
              #id.actions-container
                %i.icon-sort
        %th.order-name
          .pure-g.header-container
            .pure-u.title-container
              .title
                Order Name
            .pure-u
              #order_name.actions-container
                %i.icon-sort-by-attributes
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                Client
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                Advertiser
            .pure-u
              #advertiser.actions-container
                %i.icon-sort
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                Abbr
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                AM
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                Trafficker
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                Start Date
            .pure-u
              #start_date.actions-container
                %i.icon-sort
        %th
          .pure-g.header-container
            .pure-u.title-container
              .title
                End Date
            .pure-u
              #end_date.actions-container
                %i.icon-sort

    %tbody{:id => "orders"}
      =render "order_table" ,:orders => @orders,:users => @users

  .paginator{:id => "paginator"}
    = paginate @orders,:remote => :true

:javascript
  $(document).ready(function() {
    ReachUI.SetupGlobalErrorHandler();

    var controller = new ReachUI.Orders.OrderController();
    ReachUI.Orders.router = new ReachUI.Orders.Router({controller: controller});

    Backbone.history.start({
      pushState: true,
      root: "/orders"
    });
  });

  $('.actions-container i').click(function(event) {
    var para = {};
    para.sort_column = $(event.target).parent().attr('id');

    var class_name = $(event.target).attr('class');

    if(class_name==='icon-sort' || class_name==='icon-sort-by-attributes-alt') {
      para.sort_direction = 'asc';
      $('.order-table').find('.actions-container i').removeClass('icon-sort-by-attributes icon-sort-by-attributes-alt').addClass('icon-sort');
      $(event.target).removeClass('icon-sort-by-attributes-alt icon-sort').addClass('icon-sort-by-attributes');
    } else if(class_name==='icon-sort-by-attributes') {
      para.sort_direction = 'desc';
      $(event.target).removeClass('icon-sort-by-attributes').addClass('icon-sort-by-attributes-alt');
    }

    var filterParams = getFilterParams();
    $.extend(para, filterParams);

    var request = $.ajax({url:'/orders', data:para, dataType: 'script'});
  });

  $('#btn_delete_orders').click(function(event) {
    var para = {};

    var checkedValues = $('.ordersCheckbox:checked').map(function() {return this.value;}).get().join(',');
    para.chkVals = checkedValues;
    var sortColumn = $('.actions-container i.icon-sort-by-attributes');
    if(!sortColumn.length) sortColumn = $('.actions-container i.icon-sort-by-attributes-alt');

    if(sortColumn){
      para.sort_column = sortColumn.parent().attr('id');
      para.sort_direction = sortColumn.hasClass('icon-sort-by-attributes') ? "asc" : "desc";
    }

    if(checkedValues == '') {
      alert("No order selected");
    } else {
      var cfm = confirm("Are you sure to want to delete");
      if(cfm === true) {
        var request = $.ajax({url:'/orders/delete.json', type:'DELETE', data:"ids="+checkedValues});
        request.done(function(data){
          var request = $.ajax({url:'/orders', data:para, dataType: 'script'});
        });

        request.fail(function(){
          alert( "Request failed");
        });
      }
    }
  });

  $('.filter-orders').change(function(event) {
    var para = getFilterParams();
    var sortParams = getSortParams();
    $.extend(para, sortParams);

    var request = $.ajax({url:'/orders', data:para, dataType: 'script'});
  });

  function getFilterParams(){
    var filterParams = {},
        status= $('.status').val().toLowerCase(),
        am = $('.am').val(),
        trafficker = $('.trafficker').val();

    if(status === "all") { status = null }
    if(am === "Select") { am = null }
    if(trafficker == "Select") { trafficker = null }

    if(status){
      filterParams.order_status = status;
    }
    if(am){
      filterParams.am = am;
    }
    if(trafficker){
      filterParams.trafficker = trafficker;
    }

    return filterParams;
  }

  function getSortParams(){
    var sortParams = {};
    var sortColumn = $('.actions-container i.icon-sort-by-attributes');
    if(!sortColumn.length) sortColumn = $('.actions-container i.icon-sort-by-attributes-alt');

    if(sortColumn){
      sortParams.sort_column = sortColumn.parent().attr('id');
      sortParams.sort_direction = sortColumn.hasClass('icon-sort-by-attributes') ? "asc" : "desc";
    }

    return sortParams;
  }


