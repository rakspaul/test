(function(){commonModule.factory("dataService",function($q,$http,api,apiPaths,common,campaign_api,dataTransferService,dataStore,utils,urlService,loginModel,$cookieStore,$location,constants,analytics){$http.defaults.headers.common["Authorization"]=loginModel.getAuthToken();var errorObject={status:"error",data:{message:"Error"}};return{updateRequestHeader:function(){$http.defaults.headers.common["Authorization"]=loginModel.getAuthToken()},getSingleCampaign:function(urlPath){return this.fetch(urlPath)},
getActionItems:function(urlPath){return this.fetch(urlPath)},getCampaignStrategies:function(urlPath,type){return this.fetch(api+urlPath)},getCdbChartData:function(campaign,timePeriod,type,strategyId){var urlPath;var campaignId=campaign.orderId?campaign.orderId:dataTransferService.getClickedCampaignId();var durationQuery="period\x3d"+timePeriod;if(timePeriod==="life_time")if(campaign.startDate!=undefined&&campaign.endDate!=undefined)durationQuery="start_date\x3d"+campaign.startDate+"\x26end_date\x3d"+
campaign.endDate;else{var sd=dataTransferService.getClickedCampaignStartDate()?dataTransferService.getClickedCampaignStartDate():campaign.startDate;var ed=dataTransferService.getClickedCampaignEndDate()?dataTransferService.getClickedCampaignEndDate():campaign.endDate;durationQuery="start_date\x3d"+sd+"\x26end_date\x3d"+ed}if(type=="campaigns")urlPath=common.useTempData?common.useTempData+"/cdb.json":api+"/campaigns/"+campaignId+"/bydays/perf?"+durationQuery;else if(type=="strategies")urlPath=common.useTempData?
common.useTempData+"/cdb.json":api+"/campaigns/"+campaignId+"/strategies/"+strategyId+"/bydays/perf?"+durationQuery;return this.fetch(urlPath)},getCdbTacticsMetrics:function(campaignId,filterStartDate,filterEndDate){var url=apiPaths.apiSerivicesUrl+"/campaigns/"+campaignId+"/strategies/tactics?start_date\x3d"+filterStartDate+"\x26end_date\x3d"+filterEndDate;return this.fetch(url)},getCdbTacticsChartData:function(campaignId,strategyId,tacticsId,timePeriod,filterStartDate,filterEndDate){var url=apiPaths.apiSerivicesUrl+
"/campaigns/"+campaignId+"/strategies/"+strategyId+"/tactics/"+tacticsId+"/bydays/perf?start_date\x3d"+filterStartDate+"\x26end_date\x3d"+filterEndDate;return this.fetch(url)},getStrategyTacticList:function(strategyId){var url=apiPaths.apiSerivicesUrl+"/strategy/"+strategyId+"/tactics";return this.fetch(url)},getCostBreakdown:function(campaign){var url=apiPaths.apiSerivicesUrl+"/campaigns/costs?ids\x3d"+campaign.orderId+"\x26start_date\x3d"+campaign.startDate+"\x26end_date\x3d"+campaign.endDate;return this.fetch(url)},
getCostViewability:function(campaign,timePeriod){var url=apiPaths.apiSerivicesUrl+"/campaigns/"+campaign.orderId+"/viewReport?date_filter\x3d"+timePeriod;return this.fetch(url)},getCostInventoryData:function(campaign,timePeriod){var url=apiPaths.apiSerivicesUrl+"/campaigns/"+campaign.orderId+"/inventory/categories?kpi_type\x3d"+campaign.kpiType;return this.fetch(url)},getCostFormatsData:function(campaign,timePeriod){var url=apiPaths.apiSerivicesUrl+"/campaigns/"+campaign.orderId+"/byformats/perf?date_filter\x3d"+
timePeriod;return this.fetch(url)},getScreenData:function(campaign){var url=apiPaths.apiSerivicesUrl+"/campaigns/"+campaign.orderId+"/byscreens/perf?start_date\x3d"+campaign.startDate+"\x26end_date\x3d"+campaign.endDate;return this.fetch(url)},getActions:function(){var url=apiPaths.workflow_apiServicesUrl+"/actionTypes";return this.fetch(url)},getTactics:function(orderId){var url=apiPaths.apiSerivicesUrl+"/campaigns/"+orderId+"/strategies/tactics/meta";return this.fetch(url)},getCampaignData:function(periodKey,
campaign,periodStartDate,periodEndDate){var qs;if(periodKey==="life_time")qs="?start_date\x3d"+campaign.startDate+"\x26end_date\x3d"+campaign.endDate;else qs="?start_date\x3d"+periodStartDate+"\x26end_date\x3d"+periodEndDate;var url=api+"/campaigns/"+campaign.orderId+"/perf"+qs;return this.fetch(url)},createAction:function(data){var url=apiPaths.workflow_apiServicesUrl+"/actions";analytics.track(loginModel.getUserRole(),constants.GA_CAMPAIGN_DETAILS_CREATE_ACTIVITY,"number_of_action_subtypes_selected",
loginModel.getLoginName(),data.action_sub_type_ids.length);analytics.track(loginModel.getUserRole(),constants.GA_CAMPAIGN_DETAILS_CREATE_ACTIVITY,"number_of_tactics_selected",loginModel.getLoginName(),data.action_tactic_ids.length);analytics.track(loginModel.getUserRole(),constants.GA_CAMPAIGN_DETAILS_CREATE_ACTIVITY,data.make_external?"external":"internal",loginModel.getLoginName());return this.post(url,data,{"Content-Type":"application/json"})},updateLastViewedAction:function(campaignId){return this.put(urlService.APIlastViewedAction(campaignId),
{}).then(function(response){if(response.status==="success")dataStore.deleteAllCachedCampaignListUrls()})},fetch:function(url){loginModel.checkCookieExpiry();var cachedResponse=dataStore.getCachedByUrl(url);if(cachedResponse!=undefined){var defer=$q.defer();var promise=defer.promise.then(function(){return utils.clone(cachedResponse.value)});defer.resolve();return promise}return $http({url:url,method:"GET"}).then(function(response){if(response.status===401){loginModel.unauthorized();return errorObject}else if(response.status===
403){loginModel.forbidden();return errorObject}var objOnSuccess={status:"success",data:response.data};dataStore.cacheByUrl(url,objOnSuccess);return utils.clone(objOnSuccess)},function(error){if(error.status==401){loginModel.unauthorized();return errorObject}else if(error.status===403){loginModel.forbidden();return errorObject}return{status:"error",data:error}})},downloadFile:function(url){loginModel.checkCookieExpiry();return $http({url:url,method:"GET",responseType:"arraybuffer"}).then(function(response){if(response.status===
401){loginModel.unauthorized();return errorObject}else if(response.status===403){loginModel.forbidden();return errorObject}var objOnSuccess={status:"success",data:response.data,headers:response.headers,fileName:response.headers("filename")};objOnSuccess.file=new Blob([objOnSuccess.data],{type:objOnSuccess.headers("Content-Type")});return objOnSuccess},function(error){if(error.status==401){loginModel.unauthorized();return errorObject}else if(error.status===403){loginModel.forbidden();return errorObject}return{status:"error",
data:error}})},fetchCancelable:function(url,canceller,success,failure){loginModel.checkCookieExpiry();var cachedResponse=dataStore.getCachedByUrl(url);if(cachedResponse!=undefined){var defer=$q.defer();var promise=defer.promise.then(function(){return success.call(this,utils.clone(cachedResponse.value))});defer.resolve();return promise}return $http.get(url,{timeout:canceller.promise}).then(function(response){if(response.status===401){loginModel.unauthorized();return errorObject}else if(response.status===
403){loginModel.forbidden();return errorObject}var objOnSuccess={status:"success",data:response.data};dataStore.cacheByUrl(url,objOnSuccess);return success.call(this,utils.clone(objOnSuccess))},function(error){if(error.status===401){loginModel.unauthorized();return errorObject}else if(error.status===403){loginModel.forbidden();return errorObject}var objOnError={status:"error",data:error};if(failure!=undefined)return failure.call(this,objOnError);else return objOnError})},post:function(url,data,header){loginModel.checkCookieExpiry();
$http.defaults.headers.common["Authorization"]=loginModel.getAuthToken();return $http({url:url,method:"POST",cache:true,data:angular.toJson(data),headers:header?header:{"Content-Type":"text/plain"}}).then(function(response){if(response.status===401){loginModel.unauthorized();return errorObject}else if(response.status===403){loginModel.forbidden();return errorObject}return{status:"success",data:response.data}},function(error){if(error.status===401){loginModel.unauthorized();return errorObject}else if(error.status===
403){loginModel.forbidden();return errorObject}return{status:"error",data:error}})},put:function(url,data){loginModel.checkCookieExpiry();$http.defaults.headers.common["Authorization"]=loginModel.getAuthToken();return $http.put(url,angular.toJson(data)).then(function(response){if(response.status==401){loginModel.unauthorized();return errorObject}else if(response.status===403){loginModel.forbidden();return errorObject}return{status:"success",data:response.data}},function(error){if(error.status==401){loginModel.unauthorized();
return errorObject}else if(error.status===403){loginModel.forbidden();return errorObject}return{status:"error",data:error}})}}})})();