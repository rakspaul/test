(function(){commonModule.service("ganttChart",function(loginModel,analytics){function wrap(text,width,timeDomainString,x,height){if(timeDomainString=="month")text.each(function(){var text=d3.select(this);var words=text.text().split(/\s+/).reverse();var word;var line=[];var lineNumber=0;var lineHeight=1.1;var y=-1*(height-60);var dy=parseFloat(text.attr("dy"));var i=0;var tspan=text.text(null).append("tspan").attr("x",x).attr("y",y).attr("dy",dy+"em");for(dy=-1.2;word=words.pop();){if(word=="Jan"||
word=="Feb"||word=="Mar"||word=="Apr"||word=="May"||word=="Jun"||word=="Jul"||word=="Aug"||word=="Sep"||word=="Oct"||word=="Nov"||word=="Dec"){y=y-17;x=3}else x=9;line.push(word);tspan.text(line.join(" "));if(tspan.node().getComputedTextLength()>width){line.pop();tspan.text(line.join(" "));line=[word];tspan=text.append("tspan").attr("x",x).attr("y",y).attr("dy",++lineNumber*lineHeight+dy+"em").text(word)}}})}function addTask(){var lastEndDate=getEndDate();var taskStatusKeys=Object.keys(taskStatus);
var taskStatusName=taskStatusKeys[Math.floor(Math.random()*taskStatusKeys.length)];var taskName="TWC";var name="Test Campaign - Status:"+taskStatusName+" - Brand:"+taskName;tasks.push({"startDate":d3.time.day.offset(lastEndDate,Math.ceil(Math.random(10))),"endDate":d3.time.day.offset(lastEndDate,Math.ceil(300)+1),"taskName":taskName,"status":taskStatusName,"name":name});changeTimeDomain(timeDomainString);gantt.redraw(tasks)}function getEndDate(){var lastEndDate=Date.now();if(tasks.length>0)lastEndDate=
tasks[tasks.length-1].endDate;return lastEndDate}function prev(timeDomainString){var td=gantt.timeDomain();var scale=(td[1]-td[0])/10;gantt.timeDomain([td[0]-scale,td[1]-scale]);gantt.redraw(tasks,timeDomainString)}function next(timeDomainString){var td=gantt.timeDomain();var scale=(td[1]-td[0])/10;gantt.timeDomain([td[0]+scale,td[1]+scale]);gantt.redraw(tasks,timeDomainString)}function month(){changeTimeDomain("month")}function today(){changeTimeDomain("today")}function quarter(){changeTimeDomain("quarter")}
function year(){changeTimeDomain("year")}function changeTimeDomain(timeDomainString){var todayIs=moment();var thisMonth=moment().format("MM");var presentYear=moment().format("YYYY");switch(timeDomainString){case "1day":format="%H:%M";gantt.timeDomain([d3.time.day.offset(getEndDate(),-1),getEndDate()]);break;case "1week":format="%d";gantt.timeDomain([d3.time.day.offset(getEndDate(),-15),getEndDate()]);break;case "month":format="%d";gantt.timeDomain([moment().startOf("month"),moment().endOf("month")]);
break;case "today":format="%d";gantt.timeDomain([moment().startOf("day").subtract(3,"days"),moment().endOf("day").add(3,"days")]);break;case "quarter":format="%d";var qStart=0;var qEnd=2;if(thisMonth>=1&&thisMonth<=3){qStart=0;qEnd=2}else if(thisMonth>=4&&thisMonth<=6){qStart=3;qEnd=5}else if(thisMonth>=7&&thisMonth<=9){qStart=6;qEnd=8}else if(thisMonth>=10&&thisMonth<=12){qStart=9;qEnd=11}gantt.timeDomain([moment().month(qStart).startOf("month"),moment().month(qEnd).endOf("month")]);break;case "year":format=
"%d";gantt.timeDomain([moment().startOf("year"),moment().endOf("year")]);break;default:format="%H:%M"}gantt.tickFormat(format);gantt.redraw(tasks,timeDomainString)}function newCalendar(task,taskName,singleBrand){tasks=task;taskNames=taskName;taskStatus={"ontrack":"bar","underperforming":"bar","paused":"bar","ready":"bar","completed":"bar"};maxDate=tasks[tasks.length-1].endDate;minDate=tasks[0].startDate;format="%d";timeDomainString="quarter";var calendar_height=tasks.length*37;calendar_height=calendar_height>
MIN_CALENDAR_HEIGHT?calendar_height:MIN_CALENDAR_HEIGHT;gantt=d3.gantt(calendar_height).taskTypes(taskNames).taskStatus(taskStatus).tickFormat(format);var margin={top:20,right:40,bottom:20,left:50};gantt.isSingleBrand(singleBrand);gantt.margin(margin);gantt.timeDomainMode("fixed");changeTimeDomain(timeDomainString);gantt(tasks);gantt.redraw(tasks,timeDomainString)}function updateCalendar(task,taskName){tasks=[];taskNames=[];tasks=task;taskNames=taskName;taskStatus={"ontrack":"bar","underperforming":"bar",
"paused":"bar","ready":"bar","completed":"bar"};timeDomainString="today";changeTimeDomain(timeDomainString);gantt.redraw(tasks,timeDomainString)}this.createGanttChart=function(){};var MIN_CALENDAR_HEIGHT=500;d3.gantt=function(cal_height){function gantt(tasks){initTimeDomain(tasks);initAxis();var svg=d3.select("#calendar_widget").append("svg").attr("class","chart").attr("width",width$$0+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("class","gantt-chart").attr("width",
width$$0+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).attr("transform","translate("+margin.left+", "+margin.top+")");svg.append("rect").attr("class","marker");svg.append("rect").attr("class","marker_body");svg.append("g").attr("class","x axis").attr("transform","translate(0, "+(height-margin.top-margin.bottom)+")").transition().call(xAxis).selectAll(".tick text").attr("style","font-family:Avenir;font-size:12pt;").attr("x",function(d){return 10});svg.append("g").attr("class",
"y axis").transition().call(yAxis);gantt.draw(tasks);return gantt}var FIT_TIME_DOMAIN_MODE="fit";var FIXED_TIME_DOMAIN_MODE="fixed";var CAMPAIGN_HEIGHT=25;var CALENDAR_HEIGHT=cal_height===undefined?MIN_CALENDAR_HEIGHT:cal_height;var CALENDAR_WIDTH=1090;var isSingleBrand=false;var margin={top:20,right:40,bottom:20,left:50};var onTrackColor="#47ab1d";var underperformingColor="#ee9455";var noStatusColor="#939eae";var timeDomainStart=d3.time.day.offset(new Date,-300);var timeDomainEnd=d3.time.hour.offset(new Date,
+300);var timeDomainMode=FIT_TIME_DOMAIN_MODE;var taskTypes=[];var taskStatus=[];var height=CALENDAR_HEIGHT-margin.top-margin.bottom-5;var width$$0=CALENDAR_WIDTH-margin.right-margin.left-5;var selection=selection||d3.select("body");var tickFormat="%d";var keyFunction=function(d){return d.startDate+d.taskName+d.endDate};var rectTransform=function(d){return"translate("+x(d.startDate)+","+y(d.taskName)+")"};var markerTransform=function(){var width=x(moment().endOf("day"))-x(moment().startOf("day"));
if(width<=40)return"translate("+x(moment())+",-20)";return"translate("+x(moment().startOf("day"))+",-20)"};var x=d3.time.scale().domain([timeDomainStart,timeDomainEnd]).range([0,width$$0]).clamp(true);var y=d3.scale.ordinal().domain(taskTypes).rangeRoundBands([0,450]);var xAxis=d3.svg.axis().scale(x).orient("top").tickFormat(function(d){count++;console.log(d);if(count==1)return formatMonth(d);else return formatDay(d)}).ticks(d3.time.days,1).tickSize(height-margin.top,height-margin.top).tickPadding(-15);
var yAxis=d3.svg.axis().scale(y).orient("left").tickSize(0);var initTimeDomain=function(tasks){if(timeDomainMode===FIT_TIME_DOMAIN_MODE){if(tasks===undefined||tasks.length<1){timeDomainStart=d3.time.day.offset(new Date,-3);timeDomainEnd=d3.time.hour.offset(new Date,+3);return}timeDomainEnd=tasks[tasks.length-1].endDate;timeDomainStart=tasks[0].startDate}};var initAxis=function(timeDomainString){var range=tasks.length*15;x=d3.time.scale().domain([timeDomainStart,timeDomainEnd]).range([0,width$$0]).clamp(true);
y=d3.scale.ordinal().domain(taskTypes).rangeRoundBands([0,range]);var formatDay=d3.time.format("%d");var formatMonth=d3.time.format("%b %d");var formatQuarter=d3.time.format("%b '%y");var formatMonthOnly=d3.time.format("%b");var count=0;var tickType=d3.time.days;switch(timeDomainString){case "quarter":case "year":tickType=d3.time.months}xAxis=d3.svg.axis().scale(x).orient("top").tickFormat(function(d){count++;if(timeDomainString=="month"||timeDomainString=="today"||timeDomainString=="week")if(count==
1||moment(d).format("D")==1)return formatMonth(d);else return formatDay(d);else if(count==1)return formatQuarter(d);else return formatMonthOnly(d)}).ticks(tickType,1).tickSize(height-margin.top,height-margin.top).tickPadding(-30);yAxis=d3.svg.axis().scale(y).orient("left").tickFormat("").tickSize(0)};gantt.draw=function(tasks,timeDomainString){var prevScale=0;var svg=d3.select("#calendar_widget").select("svg");svg.on("mousedown.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",
null);svg.call(d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}).on("drag",function(){var td=gantt.timeDomain();var scale=(td[1]-td[0])/1E3;d3.event.sourceEvent.stopPropagation();td=gantt.timeDomain();gantt.timeDomain([td[0]-scale*d3.event.dx,td[1]-scale*d3.event.dx]);gantt.redraw(tasks,timeDomainString)}).on("dragend",function(){d3.event.sourceEvent.stopPropagation()}));var ganttChartGroup=svg.select(".gantt-chart");var rectData=ganttChartGroup.selectAll(".node").data(tasks,
keyFunction);var rect=rectData.enter();var rectGroup=rect.append("g").attr("class","node").on("click",function(d){if(d.type!="brand"){analytics.track(loginModel.getUserRole(),"dashboard_calendar_widget","campaign_status_"+d.state+"_performance_"+d.kpiStatus,loginModel.getLoginName());document.location="#/campaigns/"+d.id}}).on("mouseover",function(d$$0){var width=x(d$$0.endDate)-x(d$$0.startDate);var stringLength=d$$0.name.length;var newWidth=stringLength*12;if(d$$0.type!="brand")if(newWidth>width)d3.select(this).select("text.campaigns_name").text(function(d){return d.name})}).on("mouseout",
function(d$$0){var width=x(d$$0.endDate)-x(d$$0.startDate);var stringLength=d$$0.name.length;if(d$$0.type!="brand"){if(width>25)width=Math.abs(25-width);var fitCount=width/10;d3.select(this).select("text.campaigns_name").text(function(d){if(fitCount>=stringLength)return d.name;else return d.name.substr(0,fitCount)+"..."})}});rectGroup.append("text").attr("class","brand_name").attr("x",0).attr("y",0).attr("dy",".35em").attr("font-size","20px").attr("font-weight","900").attr("fill","#21252b").attr("font-family",
"Avenir").attr("style",function(d){if(d.type=="brand")return"";else return"display:none"}).text(function(d){return d.name}).transition().attr("transform",rectTransform);rectGroup.append("rect").attr("class","header").attr("style","cursor:pointer").attr("fill",function(d){if(d.kpiStatus=="ontrack")return onTrackColor;else if(d.kpiStatus=="underperforming")return underperformingColor;else return noStatusColor}).attr("width",function(d){if(d.type=="brand")return 0;else if(d.kpiStatus=="ontrack"||d.kpiStatus==
"underperforming"||d.kpiStatus=="NA"||d.kpiStatus===undefined)return x(d.endDate)-x(d.startDate);else return 0}).attr("height",CAMPAIGN_HEIGHT+1).transition().delay(0).attr("transform",rectTransform);rectGroup.append("rect").attr("x",2).attr("y",2).attr("title",function(d){return"campaign"}).attr("id",function(d,i){return"campaign-"+i}).attr("class","text_container").attr("style","cursor:pointer").attr("class",function(d){if(taskStatus[d.kpiStatus]==null)return"bar campaigns";return taskStatus[d.kpiStatus]+
" campaigns"}).attr("width",function(d){if(d.type=="brand")return 0;else{var width=x(d.endDate)-x(d.startDate)-4;if(width>=0)return width;else return 0}}).attr("height",function(d){return CAMPAIGN_HEIGHT-2}).transition().delay(0).attr("transform",rectTransform);rectGroup.append("text").attr("class","campaigns_name").attr("x",30).attr("y",CAMPAIGN_HEIGHT/2).attr("dy",".35em").attr("font-family","Avenir").attr("style",function(d){if(d.type=="brand")return"display:none";else if(x(d.endDate)-x(d.startDate)!=
0)return"cursor:pointer";else return"display:none"}).text(function(d){var width=x(d.endDate)-x(d.startDate);var stringLength=d.name.length;if(width>25)width=Math.abs(25-width);var fitCount=width/10;if(fitCount>=stringLength)return d.name;else return d.name.substr(0,fitCount)+"..."}).transition().attr("transform",rectTransform);rectGroup.append("image").attr("class","icon").attr("x",CAMPAIGN_HEIGHT/3).attr("y",CAMPAIGN_HEIGHT/5).attr("height",CAMPAIGN_HEIGHT-10).attr("width",function(d){if(d.type==
"brand")return 0;else if(x(d.endDate)-x(d.startDate)!=0)return 15;else return 0}).attr("xlink:href",function(d){switch(d.state){case "Active":return window.assets.active;case "Paused":return window.assets.paused;case "Draft":return window.assets.draft;case "Ready":return window.assets.ready;case "Completed":return window.assets.completed}}).transition().attr("transform",rectTransform);ganttChartGroup.select("rect.marker").attr("x",0).attr("y",0).attr("class","marker").attr("fill",function(){var width=
x(moment().endOf("day"))-x(moment().startOf("day"));if(width<=0)return"none";else if(width<=40){if(timeDomainString=="today")return"none";return"#74AFDD"}else return"#e7edf1"}).attr("width",function(){var width=x(moment().endOf("day"))-x(moment().startOf("day"));if(width<=0)width=0;else if(width<=40)width=2;return width}).attr("height",function(){var width=x(moment().endOf("day"))-x(moment().startOf("day"));if(width<=40)return height-margin.top;else return 4}).transition().attr("transform",markerTransform);
ganttChartGroup.select("rect.marker_body").attr("x",0).attr("y",4).attr("class","marker_body").attr("fill","#f5f9fd").attr("width",function(){var width=x(moment().endOf("day"))-x(moment().startOf("day"));if(width<=40)width=0;return width}).attr("height",function(){var width=x(moment().endOf("day"))-x(moment().startOf("day"));if(width<=40)return 0;else return height-margin.top}).transition().attr("transform",markerTransform);var node=ganttChartGroup.selectAll(".node").data(tasks,keyFunction);var campaignBody=
ganttChartGroup.selectAll(".campaigns").data(tasks,keyFunction);var campaignText=ganttChartGroup.selectAll(".campaigns_name").data(tasks,keyFunction);var brandNameText=ganttChartGroup.selectAll(".brand_name").data(tasks,keyFunction);var campaignTopStroke=ganttChartGroup.selectAll(".header").data(tasks,keyFunction);var campaignsStatusIcon=ganttChartGroup.selectAll(".icon").data(tasks,keyFunction);var translateVisualElements=function(a,type){if(type=="node")a.transition().delay(0).attr("transform",
rectTransform);else if(type=="body")a.transition().delay(0).attr("width",function(d){if(d.type=="brand")return 0;else{var width=x(d.endDate)-x(d.startDate)-4;if(width>=0)return width;else return 0}}).attr("y",function(d){return y(d.taskName)+2});else if(type=="top")a.transition().delay(0).attr("width",function(d){if(d.type=="brand")return 0;else if(d.kpiStatus=="ontrack"||d.kpiStatus=="underperforming"||d.kpiStatus=="NA"||d.kpiStatus===undefined)return x(d.endDate)-x(d.startDate);else return 0}).attr("y",
function(d){return y(d.taskName)})};var translateGraphicElements=function(a,type){if(type=="brand_name")a.transition().delay(0).attr("transform",rectTransform);else if(type=="text")a.transition().delay(0).attr("width",function(d){if(x(d.endDate)-x(d.startDate)!=0)return 15;else return 0}).attr("style",function(d){if(d.type=="brand")return"display:none";else if(x(d.endDate)-x(d.startDate)>=40)return"cursor:pointer";else return"display:none"}).attr("y",function(d){return y(d.taskName)+13}).text(function(d){var width=
x(d.endDate)-x(d.startDate);var stringLength=d.name.length;if(width>25)width=Math.abs(25-width);var fitCount=width/10;if(fitCount>=stringLength)return d.name;else return d.name.substr(0,fitCount)+"..."});else a.transition().delay(0).attr("style",function(d){if(d.type=="brand")return"display:none";else if(x(d.endDate)-x(d.startDate)>=40)return"cursor:pointer";else return"display:none"}).attr("width",function(d){if(d.type=="brand")return 0;else if(x(d.endDate)-x(d.startDate)!=0)return 15;else return 0}).attr("y",
function(d){return y(d.taskName)+6})};translateVisualElements(node,"node");translateVisualElements(campaignBody,"body");translateVisualElements(campaignTopStroke,"top");translateGraphicElements(campaignText,"text");translateGraphicElements(brandNameText,"brand_name");translateGraphicElements(campaignsStatusIcon);rectData.exit().remove();svg.select(".x").transition().call(xAxis).selectAll(".tick text").attr("style","font-family:Avenir;font-size:12pt").attr("x",function(d,i){if(timeDomainString=="month")if(i==
0)return 10;else return 10;else if(timeDomainString=="today")if(i==0)return 30;else return 60;else if(timeDomainString=="year")if(i==0)return 16;else return 26;else if(i==0)return 128;else return 145}).attr("y",function(d,i){if(timeDomainString=="month")if(i==0)return(height-10)*-1;else return(height-70)*-1;else return(height-50)*-1}).call(wrap,10,timeDomainString,function(d,i){if(timeDomainString=="month")if(i==0)return 5;else return 10;else if(timeDomainString=="today")if(i==0)return 60;else return 60;
else if(timeDomainString=="year")if(i==0)return 26;else return 26;else if(i==0)return 145;else return 145},height);svg.select(".y").transition().call(yAxis).selectAll(".tick text").attr("style","font-weight:bold;font-family:Avenir;font-size:13pt");return gantt};gantt.redraw=function(tasks,timeDomainString){initTimeDomain(tasks);initAxis(timeDomainString);gantt.draw(tasks,timeDomainString);return gantt};gantt.margin=function(value){if(!arguments.length)return margin;margin=value;return gantt};gantt.timeDomain=
function(value){if(!arguments.length)return[timeDomainStart,timeDomainEnd];timeDomainStart=+value[0],timeDomainEnd=+value[1];return gantt};gantt.timeDomainMode=function(value){if(!arguments.length)return timeDomainMode;timeDomainMode=value;return gantt};gantt.taskTypes=function(value){if(!arguments.length)return taskTypes;taskTypes=value;return gantt};gantt.taskStatus=function(value){if(!arguments.length)return taskStatus;taskStatus=value;return gantt};gantt.width=function(value){if(!arguments.length)return width$$0;
width$$0=+value;return gantt};gantt.height=function(value){if(!arguments.length)return height;height=+value;return gantt};gantt.tickFormat=function(value){if(!arguments.length)return tickFormat;tickFormat=value;return gantt};gantt.isSingleBrand=function(singleBrand){if(singleBrand==true)isSingleBrand=true;else isSingleBrand=false;return gantt};return gantt};var gantt;var tasks=[];var taskNames=[];var taskStatus;var maxDate;var minDate;var format;var timeDomainString;this.newCalendar=newCalendar;this.updateCalendar=
updateCalendar;this.addTask=addTask;this.prev=prev;this.next=next;this.month=month;this.today=today;this.year=year;this.quarter=quarter})})();(function(){commonModule.directive("ganttChart",function(){return{restrict:"EAC",templateUrl:"/assets/html/gantt_chart.html"}})})();