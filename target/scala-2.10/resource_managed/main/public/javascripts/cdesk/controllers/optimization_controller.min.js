var angObj=angObj||{};
(function(){angObj.controller("OptimizationController",function($scope,$location,$window,$anchorScroll,dataService,optimizationService,utils,$http,dataTransferService,actionChart,$timeout,domainReports,apiPaths,actionColors,campaignListService,constants,timePeriodModel,loginModel,analytics){var campaign=campaignListService;$(".main_navigation").find(".active").removeClass("active").end().find("#reports_nav_link").addClass("active");$scope.selectedCampaign=domainReports.getDefaultValues()["campaign"];$scope.selectedStrategy=
domainReports.getDefaultValues()["strategy"];$scope.selected_filters=domainReports.getDurationKpi();$scope.is_network_user=loginModel.getIsNetworkUser();$scope.download_urls={optimization:null};$scope.seeDate={value:"",className:""};$scope.dataInit=function(){$scope.tacticList=[];$scope.navigationFromReports=true;$scope.campaignActionList=[];$scope.strategies={};$scope.clicked={action:{},strategy:{action:{}},campaignName:{},orderId:{},campaign:{start_date:{},end_date:{}}};$scope.tacticNotFound=true;
$scope.filters=domainReports.getReportsDropDowns();$scope.orderByField="created_at";$scope.reverseSort=true;if(localStorage.getItem(loginModel.getUserId()+"_opt_seeDate")===undefined||localStorage.getItem(loginModel.getUserId()+"_opt_seeDate")===null){$scope.seeDate.value=false;$scope.seeDate.className=""}else{$scope.seeDate.value=localStorage.getItem(loginModel.getUserId()+"_opt_seeDate");$scope.seeDate.className=localStorage.getItem(loginModel.getUserId()+"_opt_seeDate")=="true"?"see_dates_selected":
""}};$scope.dataInit();$scope.sorting=function(orderBy,sortingOrder){$scope.orderByField=orderBy;$scope.reverseSort=!$scope.reverseSort};$scope.actionDataForSelectedStrategy=function(){var counter=0;var actionItems=$scope.campaignActionList;var actionItemsArray=[];if(actionItems.length>0&&$scope.selectedStrategy.id!=-1){for(var i=0;i<actionItems.length;i++)if(actionItems[i].lineitemId==$scope.selectedStrategy.id)for(var j=actionItems[i].action.length-1;j>=0;j--){actionItems[i].action[j].action_color=
actionColors[counter%9];$scope.clicked.strategy.action=actionItems[i].action;actionItemsArray.push(actionItems[i].action[j]);counter++}$scope.clicked.orderId=$scope.selectedCampaign.id;$scope.clicked.campaignName=$scope.selectedCampaign.name;$scope.clicked.strategy.lineitemId=$scope.selectedStrategy.id;$scope.actionItems=actionItemsArray;$scope.reachUrl="/campaigns#/campaigns/"+$scope.clicked.orderId;$scope.lineItemName=$scope.selectedStrategy.name;if(actionItemsArray.length>0){$scope.tacticNotFound=
false;$scope.loadTableData()}else $scope.tacticNotFound=true}else $scope.tacticNotFound=true;if($scope.selectedStrategy.id!=-1)$scope.loadCdbDataForStrategy();else $scope.chartForStrategy=false};$scope.actionDataForSelectedCampaign=function(){var param={campaignId:$scope.selectedCampaign.id};if($scope.campaignActionList==="undefined"||$scope.campaignActionList.length===0)optimizationService.getActionsForSelectedCampaign(param).then(function(result){if(result.status==="OK"||result.status==="success"){$scope.tacticNotFound=
false;$scope.campaignActionList=result.data.data;$scope.actionDataForSelectedStrategy()}else{$scope.tacticNotFound=true;if($scope.selectedStrategy.id!==-1)$scope.loadCdbDataForStrategy()}});else $scope.actionDataForSelectedStrategy()};$scope.getCampaignDetails=function(){var url=apiPaths.apiSerivicesUrl+"/campaigns/"+$scope.selectedCampaign.id;dataService.getSingleCampaign(url).then(function(result){if(result.data.data!==undefined){var res=result.data.data;$scope.campaign={id:res.id,start_date:res.start_date,
end_date:res.end_date,kpi_type:res.kpi_type,kpi_value:res.kpi_value}}$scope.actionDataForSelectedCampaign()},function(result){console.log("call failed")})};$scope.init=function(){if(dataTransferService.getClickedStrategy()!==undefined){$scope.clicked.strategy=dataTransferService.getClickedStrategy();$scope.clicked.action=dataTransferService.getClickedAction();$scope.clicked.campaign.start_date=dataTransferService.getClickedCampaignEndDate();$scope.clicked.campaign.end_date=dataTransferService.getClickedCampaignEndDate();
$scope.clicked.campaignName=dataTransferService.getClickedCampaignName();$scope.clicked.orderId=dataTransferService.getClickedCampaignId();$scope.reachUrl="/campaigns#/campaigns/"+$scope.clicked.orderId;$scope.lineItemName=$scope.clicked.strategy.lineItemName;$scope.navigationFromReports=dataTransferService.getNavigationFromReports();$scope.selectedCampaign.id=$scope.clicked.orderId;$scope.selectedCampaign.name=$scope.clicked.campaignName;$scope.selectedStrategy.id=$scope.clicked.strategy.lineitemId;
$scope.selectedStrategy.name=$scope.clicked.strategy.lineItemName;$scope.loadTableData()}};$scope.actionSelected=function(id){var myContainer=$(".reports_section_details_container");var scrollTo=$("#actionItem_"+id);if(scrollTo.length){myContainer.find(".action_selected").removeClass("action_selected").end().find("#actionItem_"+this.id).addClass("action_selected");myContainer.animate({scrollTop:scrollTo.offset().top-myContainer.offset().top+myContainer.scrollTop()})}localStorage.removeItem("actionSel")};
$scope.loadTableData=function(){var tacticList=[];var actionItems=$scope.clicked.strategy.action;for(var index in actionItems){var tactic_id=actionItems[index].ad_id;var grouped=false;if(tacticList.length>0){for(var i in tacticList)if(tactic_id===tacticList[i].ad_id){grouped=true;tacticList[i].actionList.push(actionItems[index]);break}if(!grouped){var tactic={};tactic.ad_id=actionItems[index].ad_id;tactic.ad_name=actionItems[index].ad_name;tactic.actionList=[];tactic.actionList.push(actionItems[index]);
tacticList.push(tactic)}}else{tactic={};tactic.ad_id=actionItems[index].ad_id;tactic.ad_name=actionItems[index].ad_name;tactic.actionList=[];tactic.actionList.push(actionItems[index]);tacticList.push(tactic)}}$scope.tacticList=tacticList;var action=dataTransferService.getClickedAction()!==undefined?dataTransferService.getClickedAction():actionItems===undefined?undefined:actionItems[0];if(action!=undefined){$scope.actionId=action.ad_id+""+action.id;if($scope.actionId!==null)$timeout(function(){$scope.actionSelected($scope.actionId)},
7E3)}};$scope.colorCoding=function(val1,val2,matricImpacted){if(val1==val2)return"";else if(matricImpacted==="CPC"||matricImpacted==="CPA"||matricImpacted==="CPM")return val1-val2>0?"negative_td":"positive_td";else return val1-val2>0?"positive_td":"negative_td"};$scope.roundOff=function(value,places){var factor=Math.pow(10,places);var rounded=Math.round(value*factor)/factor;return Math.abs(rounded)};$scope.goToGraph=function(id){$("html,body").animate({scrollTop:0},"300")};$scope.showSelected=function(id,
isActionExternal){var circleId=0;var getActivityCount=0;$("circle[id_list*\x3d"+id+"]").each(function(index,element){circleId=parseInt(this["id"]);getActivityCount=this.getAttribute("activityCount")});var newId=circleId>0?circleId:id;$("#action-container:first").find(".action_selected").removeClass("action_selected").end().find("#actionItem_"+id).addClass("action_selected");$(".reports_section_details_container").find(".action_selected").removeClass("action_selected").end().find("#actionItem_"+id).addClass("action_selected");
$("circle").attr({fill:"#fff"});$("text").attr({fill:"#000"});$("circle#"+newId).attr({fill:isActionExternal==false?"#777":"#0072bc"});if(getActivityCount>1)$("text#t"+newId).css({fill:"#fff"});localStorage.setItem("actionSel","actionItem_"+id);analytics.track(loginModel.getUserRole(),constants.GA_OPTIMIZATION_TAB,constants.GA_OPTIMIZATION_TAB_ACTIVITY_SELECTED,loginModel.getLoginName())};$scope.chartForStrategy=true;$scope.loadCdbDataForStrategy=function(){if($scope.navigationFromReports==true)var param=
{orderId:parseInt($scope.selectedCampaign.id),startDate:$scope.campaign.start_date,endDate:$scope.campaign.end_date};else param={orderId:parseInt($scope.selectedCampaign.id),startDate:$scope.clicked.campaign.start_date,endDate:$scope.clicked.campaign.end_date};var strategyId=$scope.selectedStrategy.id;dataService.getCdbChartData(param,"lifetime","strategies",strategyId,true).then(function(result){var lineData=[];if(result.status=="success"&&!angular.isString(result.data)){if(param.orderId==$scope.selectedCampaign.id){var kpiType=
dataTransferService.getClickedKpiType()=="null"||dataTransferService.getClickedKpiType()==null?$scope.campaign.kpi_type:dataTransferService.getClickedKpiType();var kpiValue=dataTransferService.getClickedKpiValue()?dataTransferService.getClickedKpiValue():$scope.campaign.kpi_value;var actionItems=dataTransferService.getClickedActionItems()?dataTransferService.getClickedActionItems():$scope.actionItems;if(!angular.isUndefined(kpiType)){if(result.data.data.measures_by_days.length>0)if($scope.selectedCampaign.id==
param.orderId&&$scope.selectedStrategy.id==strategyId){var maxDays=result.data.data.measures_by_days;for(var i=0;i<maxDays.length;i++){maxDays[i]["ctr"]*=100;var kpiTypeLower=angular.lowercase(kpiType);kpiTypeLower=kpiTypeLower=="null"||kpiTypeLower==undefined?"ctr":kpiTypeLower;lineData.push({"x":i+1,"y":utils.roundOff(maxDays[i][kpiTypeLower],2),"date":maxDays[i]["date"]})}$scope.chartForStrategy=actionChart.lineChart(lineData,parseFloat(kpiValue),kpiType,actionItems,990,250,true,$scope.actionId,
$scope.clicked,$scope.navigationFromReports)}else $scope.chartForStrategy=false}else $scope.chartForStrategy=false}}else $scope.chartForStrategy=false})};$scope.showIcon=function(id){$scope.iconIdToShow=id};$scope.hideIcon=function(id){$scope.iconIdToShow=-1};$scope.callBackCampaignsSuccess=function(){dataTransferService.updateExistingStorageObjects({filterKpiType:dataTransferService.getDomainReportsValue("filterKpiType")?dataTransferService.getDomainReportsValue("filterKpiType"):$("#campaigns_list li:first").attr("_kpi"),
filterKpiValue:dataTransferService.getDomainReportsValue("filterKpiValue")?dataTransferService.getDomainReportsValue("filterKpiValue"):$("#campaigns_list li:first").attr("_kpi")==="action_rate"?"Action Rate":$("#campaigns_list li:first").attr("_kpi")});var urlPath=apiPaths.apiSerivicesUrl+"/campaigns/"+$scope.selectedCampaign.id+"/optimization/";$scope.download_urls={optimization:urlPath+"download?date_filter\x3d"+$scope.selected_filters.time_filter}};$scope.callBackCampaignsFailure=function(){};
$scope.updateStrategyObjects=function(strategy){$scope.strategies=strategy;if($scope.navigationFromReports==true)if($scope.strategies!=="undefined"&&$scope.strategies.length>0){var strategyObj=domainReports.loadFirstStrategy($scope.strategies[0].id,$scope.strategies[0].name);$scope.selectedStrategy.id=strategyObj.id;$scope.selectedStrategy.name=strategyObj.name;$scope.selectedStrategy.startDate=strategyObj.startDate;$scope.selectedStrategy.endDate=strategyObj.endDate;$scope.strategyFound=true;if($scope.selectedStrategy.id!==
-1)$scope.getCampaignDetails();else{$scope.tacticNotFound=true;$scope.chartForStrategy=false}}else{$scope.selectedStrategy=domainReports.getNotFound()["strategy"];$scope.chartForStrategy=false;$scope.tacticNotFound=true;$scope.strategies={}}};$scope.strategylist=function(campaignId){if($scope.navigationFromReports==true)$scope.selectedStrategy.name="Loading...";domainReports.getCampaignStrategyList(campaignId).then(function(result){if(result.status=="success"){var strategy=result.data.data;$scope.updateStrategyObjects(strategy)}else{$scope.selectedStrategy=
domainReports.getNotFound()["strategy"];$scope.tacticNotFound=true;$scope.chartForStrategy=false}})};$scope.callBackCampaignChange=function(){$scope.navigationFromReports=true;$scope.dataInit();$scope.selectedStrategy=domainReports.getDefaultValues()["strategy"];if($scope.selectedCampaign.id!==-1){$scope.chartForStrategy=true;$scope.strategylist($scope.selectedCampaign.id);$scope.callBackCampaignsSuccess()}else{$scope.chartForStrategy=false;$scope.selectedStrategy=domainReports.getNotFound()["strategy"];
$scope.strategies={}}};$scope.callBackKpiDurationChange=function(kpiType){$scope.chartForStrategy=true;if(kpiType=="duration"){if($scope.selectedStrategy.id!==-1)$scope.actionDataForSelectedCampaign();dataTransferService.updateExistingStorageObjects({"filterDurationType":$scope.selected_filters.time_filter,"filterDurationValue":$scope.selected_filters.time_filter_text});var urlPath=apiPaths.apiSerivicesUrl+"/campaigns/"+$scope.selectedCampaign.id+"/optimization/";$scope.download_urls={optimization:urlPath+
"download?date_filter\x3d"+$scope.selected_filters.time_filter}}};$scope.callBackStrategyChange=function(){$scope.chartForStrategy=true;if($scope.selectedStrategy.id!==-1){$scope.actionDataForSelectedCampaign();analytics.track(loginModel.getUserRole(),constants.GA_USER_STRATEGY_SELECTION,$scope.selectedStrategy.name,loginModel.getLoginName())}else{$scope.chartForStrategy=false;$scope.tacticNotFound=true}};$("#optimization_squaredFour").click(function(){if($(this).is(":checked")==true){localStorage.setItem(loginModel.getUserId()+
"_opt_seeDate",true);$scope.seeDate.value=true;$scope.seeDate.className="see_dates_selected";$(".details_with_heading_total").addClass("see_dates_selected");analytics.track(loginModel.getUserRole(),constants.GA_OPTIMIZATION_TAB,constants.GA_OPTIMIZATION_TAB_SEE_DATES,loginModel.getLoginName())}else{localStorage.setItem(loginModel.getUserId()+"_opt_seeDate",false);$scope.seeDate.value=false;$scope.seeDate.className="";$(".details_with_heading_total").removeClass("see_dates_selected")}$scope.$apply()});
$scope.$on(constants.EVENT_TIMEPERIOD_CHANGED,function(event){$scope.callBackKpiDurationChange("duration")});$scope.downloadOptimizationReport=function(report_url){$window.location.href=report_url;analytics.track(loginModel.getUserRole(),constants.GA_DOWNLOAD_REPORT,"optimization_report",loginModel.getLoginName())}})})();