(function(){commonModule.factory("actionChart",function($timeout,loginModel,constants,analytics){var kpiPrefix=function(kpiType){var kpiTypeLower=kpiType.toLowerCase();return kpiTypeLower=="cpc"||kpiTypeLower=="cpa"||kpiTypeLower=="cpm"?"$":""};var kpiSuffix=function(kpiType){var kpiTypeLower=kpiType.toLowerCase();return kpiTypeLower=="vtc"?"%":""};var drawMarker=function(chart,xPos,yPos,markerColor,kpiType,kpiValue,actionId,actionComment,isActionExternal,defaultGrey,activityCount,id_list){var text;
var textBG;var marker;var container;var display_color=activityCount==1?"transparent":"#000";var flagId=isActionExternal==true?"external":"internal";var display_activityCount="";var applyColor="";if(activityCount>1)applyColor=1;else applyColor=0;var place_circle_x=7;if(activityCount.toString().length>1)display_activityCount=" "+activityCount+" ";else display_activityCount='    \x3cspan style\x3d"color:transparent"\x3e-\x3c/span\x3e'+activityCount+" ";var numberOfActivityHeader=isActionExternal==true?
"\x3cb\x3e"+activityCount+"\x3c/b\x3e External Activities":"\x3cb\x3e"+activityCount+"\x3c/b\x3e Internal Activities";marker=chart.renderer.text(display_activityCount,xPos-7,yPos+2).attr({id:"t"+actionId||"NA",removeX:16,flagId:flagId,zIndex:9,applyColor:applyColor}).css({fontSize:"12px",textAlign:"center",leftMargin:"20px",rightMargin:"40px",position:"absolute",padding:5,fontFamily:"Avenir",fontWeight:"600",color:display_color,cursor:"pointer"}).on("click",function(markerObj){$("#"+actionId).click()}).on("mouseover",
function(e){}).on("mouseout",function(e){}).add(),container=marker.getBBox();chart.renderer.circle(container.x+place_circle_x,container.y+8,10).attr({fill:"#fff",stroke:defaultGrey==false||isActionExternal==false?"#777":"#0072bc","stroke-width":2.5,id:actionId||"NA",kpiType:kpiType||"NA",kpiValue:kpiValue||"NA",comment:actionComment||"NA",id_list:id_list,activityCount:activityCount,zIndex:4}).css({cursor:"pointer"}).on("mouseover",function(event){chart.tooltip.hide();var x=event.offsetX;var y=event.offsetY;
var correctionX=0;var symbol="";var suffix="";if(chart.plotWidth-x<0)correctionX=(chart.plotWidth-x)*2-10;symbol=kpiPrefix(kpiType);suffix=kpiSuffix(kpiType);var html_comment=this.getAttribute("comment").toString();html_comment=html_comment.replace(/(?:\\r\\n|\r|\\n| \\n)/g,"\x3cbr /\x3e");if(activityCount>1){$(".highcharts-tooltip").hide();html_comment=numberOfActivityHeader}text=chart.renderer.text(this.getAttribute("kpiType")+": \x3cb\x3e"+symbol+this.getAttribute("kpiValue")+suffix+"\x3c/b\x3e\x3cbr\x3e"+
html_comment,x+10+correctionX,y+10*2).attr({zIndex:16}).css({fillColor:"#fff",color:"#000"}).add();var box=text.getBBox();textBG=chart.renderer.rect(box.x-5,box.y-5,box.width+10,box.height+10,5).attr({fill:"#ffffff",stroke:"#0072bc"||"grey","stroke-width":1,zIndex:15}).add()}).on("mouseout",function(event){text.destroy();textBG.destroy();$(".highcharts-tooltip").show()}).on("click",function(circleObj){var myContainer=$("#action-container:first");var getIdList=this.getAttribute("id_list");var splitIdList=
getIdList.split(",");$("circle").attr({fill:"#ffffff"});if(splitIdList.length>1)for(var i=0;i<splitIdList.length;i++){var targetId=splitIdList[i];$("circle#"+targetId).attr({fill:isActionExternal==false?"#777":"#0072bc"})}else $("circle#"+circleObj.target.id).attr({fill:isActionExternal==false?"#777":"#0072bc"});$("text[applyColor\x3d1]").css({fill:"#000"});var getactivityCount=this.getAttribute("activityCount");if(getactivityCount>1)$("text#t"+circleObj.target.id).css({fill:"#fff"});if(defaultGrey){myContainer=
$(".reports_section_details_container");var scrollTo=$("#actionItem_"+this.id);localStorage.setItem("actionSel",this.id);if(scrollTo.length){scrollTo.siblings().removeClass("action_selected").end().addClass("action_selected");if(splitIdList.length>1)for(i=0;i<splitIdList.length;i++){targetId=splitIdList[i];myContainer.find("#actionItem_"+targetId).addClass("action_selected");myContainer.animate({scrollTop:scrollTo.offset().top-myContainer.offset().top+myContainer.scrollTop()})}else{myContainer.find(".action_selected").removeClass("action_selected").end().find("#actionItem_"+
this.id).addClass("action_selected");myContainer.animate({scrollTop:scrollTo.offset().top-myContainer.offset().top+myContainer.scrollTop()})}analytics.track(loginModel.getUserRole(),constants.GA_OPTIMIZATION_TAB,"optimization_graph_activity_marker_click",loginModel.getLoginName())}}else{scrollTo=$("#actionItem_"+this.id);localStorage.setItem("actionSel",this.id);if(scrollTo.length){scrollTo.siblings().removeClass("active").end().addClass("active");if(splitIdList.length>1){myContainer.find(".active").removeClass("active").end();
for(i=0;i<splitIdList.length;i++){targetId=splitIdList[i];myContainer.find("#actionItem_"+targetId).addClass("active");myContainer.animate({scrollTop:scrollTo.offset().top-myContainer.offset().top+myContainer.scrollTop()})}}else{myContainer.find(".active").removeClass("active").end().find("#actionItem_"+this.id).addClass("active");myContainer.animate({scrollTop:scrollTo.offset().top-myContainer.offset().top+myContainer.scrollTop()})}analytics.track(loginModel.getUserRole(),constants.GA_CAMPAIGN_DETAILS,
"campaign_performance_graph_activity_click",loginModel.getLoginName())}}}).add()};var lineChart=function(lineData,threshold,kpiType,actionItems,width,height,defaultGrey,actionId,external,navigationFromReports){var data=[];var dataArr=[];kpiType=kpiType!="null"?kpiType:"NA";for(var i=0;i<lineData.length;i++){var chartData=lineData[i]["date"].split("-");dataArr.push(lineData[i]["y"]);data.push([Date.UTC(parseInt(chartData[0]),parseInt(chartData[1],10)-1,parseInt(chartData[2])),lineData[i]["y"]])}var dataLength=
data.length;var timeInterval=dataLength/7;var minVal=Math.min.apply(Math,dataArr);var maxVal=Math.max.apply(Math,dataArr);var range=parseFloat(parseFloat(maxVal)-parseFloat(minVal));var percentage=(parseFloat(maxVal)-parseFloat(minVal))/100*15;var chartMinimum=parseFloat(parseFloat(minVal)-parseFloat(percentage));var chartMaximum=parseFloat(parseFloat(maxVal)+parseFloat(percentage));return{options:{chart:{width:width?width:400,height:height?height:330,margin:[25,0,50,60]},title:{text:"",style:{"color":"#ffffff"}},
credits:{enabled:false},legend:{enabled:false},xAxis:[{type:"datetime",maxPadding:0,minPadding:0,tickWidth:0,labels:{formatter:function(){if(this.isFirst)return Highcharts.dateFormat("%e",this.value);else return Highcharts.dateFormat("%e",this.value)}},tickInterval:Math.ceil(timeInterval)*24*3600*1E3},{lineWidth:0,minorGridLineWidth:0,lineColor:"transparent",minorTickLength:0,tickLength:0,tickWidth:0,type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%b",this.value)}},tickInterval:Math.ceil(timeInterval)*
24*3600*1E3}],yAxis:{maxPadding:0,minPadding:0,max:chartMaximum,title:{align:"high",offset:13,text:kpiType,rotation:0,y:-5},gridLineWidth:0,minorGridLineWidth:0,lineWidth:1,tickWidth:0,labels:{formatter:function(){return kpiPrefix(kpiType)+this.value+kpiSuffix(kpiType)}},plotBands:[{color:"#fbdbd1",label:{enabled:false,text:"",style:{color:"red"}}}],plotLines:[{label:{text:"Baseline",x:25},color:"orange",width:0,value:threshold,dashStyle:"longdashdot"}]},tooltip:{crosshairs:[{dashStyle:"dash"}],enabled:true,
formatter:function(){var symbol=kpiPrefix(kpiType);var suffix=kpiSuffix(kpiType);if(typeof this.point.options.note==="undefined")return this.series.name+":"+" \x3cb\x3e"+symbol+this.point.y+suffix+"\x3c/b\x3e\x3cbr/\x3e";else return this.series.name+":"+" \x3cb\x3e"+symbol+this.point.y+suffix+"\x3cbr\x3e"+this.point.options.note.text+"\x3c/b\x3e\x3cbr/\x3e"}}},series:[{id:"series-1",marker:{enabled:false},states:{hover:{enabled:false}},name:kpiType,data:data,color:"#00bff0"}],loading:false,func:function(chart){$timeout(function(){var counter=
0;var flag=[];var position=0;var showExternal;if(chart!="undefined"){var extremesX=chart.xAxis[0].getExtremes();chart.xAxis[1].setExtremes(extremesX.min-0.5,extremesX.max+0.5);var extremes=chart.yAxis[0].getExtremes();if(kpiType.toLowerCase()=="cpc"||kpiType.toLowerCase()=="cpa"||kpiType.toLowerCase()=="cpm"){if(extremes.max<=threshold)chart.yAxis[0].setExtremes(0,extremes.max+(threshold-extremes.max)+0.5)}else if(extremes.max<threshold)chart.yAxis[0].setExtremes(0,extremes.max+(threshold-extremes.max));
extremes=chart.yAxis[0].getExtremes();chart.yAxis[0].addPlotBand({from:threshold,to:kpiType.toLowerCase()=="cpc"||kpiType.toLowerCase()=="cpa"||kpiType.toLowerCase()=="cpm"?extremes.max:extremes.min,color:"#fbdbd1",label:{enabled:false,text:"",style:{color:"red"}}});chart.yAxis[0].addPlotLine({value:extremes.max,color:"#D2DEE7",width:1,id:"plot-line-1"});chart.xAxis[0].addPlotLine({value:extremesX.max,color:"#D2DEE7",width:1,id:"plot-line-1"});chart.xAxis[0].addPlotLine({value:extremesX.min,color:"#D2DEE7",
width:1,id:"plot-line-1"});chart.yAxis[0].addPlotLine({value:threshold,color:"#FABD82",width:1,id:"plot-line-1"});var renderPos;if(threshold<=chart.yAxis[0].max&&threshold>=chart.yAxis[0].min)chart.renderer.image(assets.target_marker,0,chart.yAxis[0].toPixels(threshold)-chart.plotTop/2,17,17).add();if(external!=undefined&&external==true)showExternal=true;var countActivityItem=new Array;var findPlacedActivity=new Array;var eFlag=0;if(actionItems)for(i=chart.series[0].data.length-1;i>=0;i--){position=
0;for(var j=actionItems.length-1;j>=0;j--){var dateUTC=new Date(actionItems[j].created_at);var actionUTC=Date.UTC(dateUTC.getUTCFullYear(),dateUTC.getUTCMonth(),dateUTC.getUTCDate());if(chart.series[0].data[i].x==actionUTC){if(flag[actionUTC]===undefined)flag[actionUTC]=1;if(showExternal&&actionItems[j].make_external==true||showExternal===undefined){eFlag=actionItems[j].make_external;if(countActivityItem[actionUTC]==undefined){countActivityItem[actionUTC]=[];countActivityItem[actionUTC]["externalIDS"]=
[];countActivityItem[actionUTC]["internalIDS"]=[];countActivityItem[actionUTC]["external"]=0;countActivityItem[actionUTC]["internal"]=0}if(eFlag==true)if(countActivityItem[actionUTC]["external"]!=undefined){countActivityItem[actionUTC]["external"]++;var arrayVar="externalIDS"}else;else{arrayVar="internalIDS";if(countActivityItem[actionUTC]["internal"]!=undefined)countActivityItem[actionUTC]["internal"]++;else;}var activity_id=actionItems[j].ad_id+""+actionItems[j].id;var check_morethan_one=countActivityItem[actionUTC][arrayVar].length>
0?",":"";countActivityItem[actionUTC][arrayVar]=countActivityItem[actionUTC][arrayVar]+check_morethan_one+activity_id}}}}var activityCount=0;if(actionItems)for(i=chart.series[0].data.length-1;i>=0;i--){position=0;for(j=actionItems.length-1;j>=0;j--){dateUTC=new Date(actionItems[j].created_at);actionUTC=Date.UTC(dateUTC.getUTCFullYear(),dateUTC.getUTCMonth(),dateUTC.getUTCDate());if(chart.series[0].data[i].x==actionUTC){if(flag[actionUTC]===undefined)flag[actionUTC]=1;if(showExternal&&actionItems[j].make_external==
true||showExternal===undefined){var checkFlag=actionItems[j].make_external==true?"external":"internal";arrayVar=actionItems[j].make_external==true?"externalIDS":"internalIDS";activityCount=countActivityItem[actionUTC][checkFlag];var id_list=countActivityItem[actionUTC][arrayVar];if(activityCount==1){drawMarker(chart,chart.series[0].data[i].plotX+chart.plotLeft,chart.series[0].data[i].plotY+chart.plotTop+position,actionItems[j].action_color,kpiType,chart.series[0].data[i].y,actionItems[j].ad_id+""+
actionItems[j].id,actionItems[j].comment,actionItems[j].make_external,defaultGrey,activityCount,id_list);counter++;position+=10}else{if(findPlacedActivity[actionUTC]==undefined){findPlacedActivity[actionUTC]=[];findPlacedActivity[actionUTC]["external"]=0;findPlacedActivity[actionUTC]["internal"]=0}if(findPlacedActivity[actionUTC][checkFlag]!="completed"){findPlacedActivity[actionUTC][checkFlag]="completed";drawMarker(chart,chart.series[0].data[i].plotX+chart.plotLeft,chart.series[0].data[i].plotY+
chart.plotTop+position,actionItems[j].action_color,kpiType,chart.series[0].data[i].y,actionItems[j].ad_id+""+actionItems[j].id,actionItems[j].comment,actionItems[j].make_external,defaultGrey,activityCount,id_list);counter++;position+=20}}}}}}if(navigationFromReports==false&&actionId!==undefined){$("circle#"+actionId).attr({stroke:"#0070CE",fill:"#0070CE"});$("#action-container:first").find(".action_selected").removeClass("action_selected").end().find("#actionItem_"+actionId).addClass("action_selected");
$(".reports_section_details_container").find(".action_selected").removeClass("action_selected").end().find("#actionItem_"+actionId).addClass("action_selected")}}},1E3)}}};return{lineChart:lineChart}})})();